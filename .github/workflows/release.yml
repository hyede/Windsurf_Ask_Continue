# ============================================================
# GitHub Actions å·¥ä½œæµï¼šè‡ªåŠ¨æ‰“åŒ… VSIX å¹¶å‘å¸ƒ Release
# ============================================================
# è§¦å‘æ¡ä»¶ï¼šæ¨é€ v* æ ¼å¼çš„ tagï¼ˆå¦‚ v1.3.2ï¼‰
# åŠŸèƒ½ï¼š
#   1. å®‰è£…ä¾èµ–å¹¶ç¼–è¯‘ TypeScript
#   2. æ‰“åŒ…ç”Ÿæˆ VSIX æ–‡ä»¶
#   3. ç¼–è¯‘ Go MCP Serverï¼ˆå¤šå¹³å°ï¼‰
#   4. åˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
# ============================================================

name: å‘å¸ƒ Release

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v1.3.1 ç­‰æ ¼å¼çš„ tag

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release
    
    steps:
      # ========== æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç  ==========
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # ========== æ­¥éª¤ 2ï¼šè®¾ç½® Node.js ç¯å¢ƒ ==========
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # ========== æ­¥éª¤ 3ï¼šè®¾ç½® Go ç¯å¢ƒ ==========
      - name: è®¾ç½® Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: mcp-server-go/go.sum
      
      # ========== æ­¥éª¤ 4ï¼šå®‰è£… Node ä¾èµ– ==========
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      # ========== æ­¥éª¤ 5ï¼šç¼–è¯‘ TypeScript ==========
      - name: ç¼–è¯‘ TypeScript
        run: npm run compile
      
      # ========== æ­¥éª¤ 6ï¼šå®‰è£… vsce æ‰“åŒ…å·¥å…· ==========
      - name: å®‰è£… vsce
        run: npm install -g @vscode/vsce
      
      # ========== æ­¥éª¤ 7ï¼šæ‰“åŒ… VSIX ==========
      - name: æ‰“åŒ… VSIX
        run: vsce package --no-dependencies
      
      # ========== æ­¥éª¤ 8ï¼šç¼–è¯‘ Go å¤šå¹³å°ç‰ˆæœ¬ ==========
      - name: ç¼–è¯‘ Go MCP Serverï¼ˆå¤šå¹³å°ï¼‰
        working-directory: mcp-server-go
        run: |
          # Windows 64ä½
          GOOS=windows GOARCH=amd64 go build -o ask-continue-mcp-windows-amd64.exe server.go
          # Mac Intel
          GOOS=darwin GOARCH=amd64 go build -o ask-continue-mcp-darwin-amd64 server.go
          # Mac Apple Silicon
          GOOS=darwin GOARCH=arm64 go build -o ask-continue-mcp-darwin-arm64 server.go
          # Linux 64ä½
          GOOS=linux GOARCH=amd64 go build -o ask-continue-mcp-linux-amd64 server.go
          echo "Go å¤šå¹³å°ç¼–è¯‘å®Œæˆï¼š"
          ls -la ask-continue-mcp-*
      
      # ========== æ­¥éª¤ 9ï¼šè·å–ç‰ˆæœ¬å· ==========
      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"
      
      # ========== æ­¥éª¤ 10ï¼šåˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶ ==========
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          name: "v${{ steps.get_version.outputs.version }} - Windsurf å¯¹è¯å¢å¼ºå·¥å…·"
          body: |
            ## ğŸš€ Windsurf å¯¹è¯å¢å¼ºå·¥å…· v${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|
            | `*.vsix` | Windsurf æ‰©å±•ï¼ˆå¿…é¡»å®‰è£…ï¼‰ |
            | `install.bat` / `install.sh` | ä¸€é”®å®‰è£…è„šæœ¬ |
            | `ask-continue-mcp-windows-amd64.exe` | Windows Go ç‰ˆæœ¬ |
            | `ask-continue-mcp-darwin-arm64` | Mac Apple Silicon Go ç‰ˆæœ¬ |
            | `ask-continue-mcp-darwin-amd64` | Mac Intel Go ç‰ˆæœ¬ |
            | `ask-continue-mcp-linux-amd64` | Linux Go ç‰ˆæœ¬ |
            
            ### ğŸ“ å®‰è£…æ–¹å¼
            1. ä¸‹è½½ `.vsix` æ–‡ä»¶å’Œå¯¹åº”å¹³å°çš„å®‰è£…è„šæœ¬
            2. è¿è¡Œå®‰è£…è„šæœ¬ï¼ˆWindows: `install.bat`ï¼ŒMac/Linux: `./install.sh`ï¼‰
            3. æŒ‰æç¤ºå®‰è£… VSIX æ‰©å±•
            4. **é‡å¯ Windsurf**
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md#-æ›´æ–°æ—¥å¿—) ä¸­çš„æ›´æ–°æ—¥å¿—ã€‚
            
            ---
            
            **â­ å¦‚æœè§‰å¾—å¥½ç”¨ï¼Œè¯·ç»™ä¸ª Star æ”¯æŒä¸€ä¸‹ï¼**
          files: |
            *.vsix
            install.bat
            install.sh
            uninstall.bat
            uninstall.sh
            mcp-server-go/ask-continue-mcp-windows-amd64.exe
            mcp-server-go/ask-continue-mcp-darwin-amd64
            mcp-server-go/ask-continue-mcp-darwin-arm64
            mcp-server-go/ask-continue-mcp-linux-amd64
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
